import json
import os
import sys
from shutil import copy,rmtree
from datetime import datetime
import payloads.inject as ij

json_data = open("vuln.json","r")
data = json.load(json_data)
target = ij.BASE_URL

dirname = "exploits/"

rmtree(os.getcwd()+"/"+dirname, ignore_errors=True)
if not os.path.exists(dirname):
	os.makedirs(dirname)

copy("exploit.py", dirname)

for d in data:
	c = d["class"]

	result = d["results"][list(d["results"])[0]]
	for count,r in enumerate(result):	
		valueString=""	
		for paramcount,param in enumerate(list(r["params"])):
			newPayload= r["params"][param].replace('"','\\"')
			valueString += "arg"+str(paramcount)+'="'+newPayload +'"\n'

		pvString = "".join(["'"+str(key)+"'" + ' "$arg'+str(index)+'" ' for index,key in enumerate(r["params"])])
		cmdString = "\npython exploit.py "+ "'" + target + r["endpoint"]+"' " + r["method"] + " " + pvString
		cmdString= valueString + cmdString
	
		with open(dirname+c.replace(" ","")+str(count)+".sh","w+") as f:
			f.write("#/bin/sh\n")
			f.write(cmdString)
	


